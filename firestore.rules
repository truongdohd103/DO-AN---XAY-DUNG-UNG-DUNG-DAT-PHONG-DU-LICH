rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - users can only read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // Hotels collection - public read, admin write
    match /hotels/{hotelId} {
      allow read: if true; // Public read for all users
      allow write: if request.auth != null && 
        (request.auth.token.admin == true || 
         resource == null); // Allow creation for authenticated users
    }
    
    // Rooms collection - public read, admin write
    match /rooms/{roomId} {
      allow read: if true; // Public read for all users
      allow write: if request.auth != null && 
        (request.auth.token.admin == true || 
         resource == null); // Allow creation for authenticated users
    }
    
    // Bookings collection - users can only access their own bookings
    match /bookings/{bookingId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.keys().hasAll(['userId', 'hotelId', 'roomId', 'dateFrom', 'dateTo', 'guests', 'adults', 'children', 'rooms', 'price', 'totalPrice', 'status', 'paymentMethod', 'createdAt', 'updatedAt']);
    }
    
    // Reviews collection - public read, users can only write their own reviews
    match /reviews/{reviewId} {
      allow read: if true; // Public read for all users
      allow write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Bookmarks collection - users can only access their own bookmarks
    match /bookmarks/{bookmarkId} {
      allow read, write, delete: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Vouchers collection - public read, admin write
    match /vouchers/{voucherId} {
      allow read: if true; // Public read for all users
      allow write: if request.auth != null && 
        request.auth.token.admin == true;
    }
    
    // Notifications collection - users can only access their own notifications
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Bills collection - users can only access their own bills
    match /bills/{billId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Payments collection - users can only access their own payments
    match /payments/{paymentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
  }
}
